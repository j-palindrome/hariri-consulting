import{S as N}from"./stega.browser-CJ5dsYcC.js";import{s as k}from"./index.browser-rVRsldjq.js";import{s as O}from"./stegaEncodeSourceMap-BbGkQV0O.js";import"./components-DEPq4dSd.js";import"./jsx-runtime-7ou52q_D.js";let I;const J=new Uint8Array(16);function K(){if(!I&&(I=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!I))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return I(J)}const u=[];for(let n=0;n<256;++n)u.push((n+256).toString(16).slice(1));var E={randomUUID:typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function C(n,c,t){if(E.randomUUID&&!c&&!n)return E.randomUUID();const l=(n=n||{}).random||(n.rng||K)();if(l[6]=15&l[6]|64,l[8]=63&l[8]|128,c){t=t||0;for(let o=0;o<16;++o)c[t+o]=l[o];return c}return function(o,a=0){return u[o[a+0]]+u[o[a+1]]+u[o[a+2]]+u[o[a+3]]+"-"+u[o[a+4]]+u[o[a+5]]+"-"+u[o[a+6]]+u[o[a+7]]+"-"+u[o[a+8]]+u[o[a+9]]+"-"+u[o[a+10]]+u[o[a+11]]+u[o[a+12]]+u[o[a+13]]+u[o[a+14]]+u[o[a+15]]}(l)}const L=["channel/disconnect","channel/response","channel/heartbeat"],T=["handshake/syn","handshake/syn-ack","handshake/ack"],V=n=>L.some(c=>c===n),q=n=>T.some(c=>c===n),A=({data:n={}})=>typeof n=="object"&&n!==null&&!Array.isArray(n)&&!("domain"in n)&&["id","type","from","to"].every(c=>c in n)&&n.type.startsWith("handshake/");function F(n){const c=window.self!==window.top||window.opener,t={buffer:[],id:null,origin:null,source:null,status:"connecting"};function l(e,s){if(q(e)||V(e)||t.status!=="connecting"&&t.status!=="reconnecting"){if(t.id&&t.origin&&t.source){const d={connectionId:t.id,data:s,domain:"sanity/channels",from:n.id,id:C(),to:n.connectTo,type:e};try{t.source.postMessage(d,{targetOrigin:t.origin})}catch{throw new Error(`Failed to postMessage '${d.id}' on '${n.id}'`)}}}else t.buffer.push({type:e,data:s})}function o(e){if(A(e))console.error(`Visual editing package mismatch detected! Please ensure you are using the latest version of Sanity Studio and any packages listed here:
https://github.com/sanity-io/visual-editing`);else if(function(s){const{data:d}=s;return d.domain==="sanity/channels"&&d.to===n.id&&d.from===n.connectTo&&d.type!=="channel/response"}(e)){const{data:s}=e;if(t.origin&&e.origin!==t.origin)return;if(e.source&&t.source!==e.source&&(t.source=e.source),q(s.type)&&s.data){if(s.type==="handshake/syn")return t.origin=e.origin,t.id=s.data.id,g("connecting"),void l("handshake/syn-ack",{id:t.id});if(s.type==="handshake/ack"&&s.data.id===t.id)return void g("connected")}else if(s.connectionId===t.id&&e.origin===t.origin){if(s.type==="channel/disconnect")return void g("disconnected");{const d=[s.type,s.data];a.forEach(h=>{h(...d)}),l("channel/response",{responseTo:s.id})}return}}}const a=new Set,v=new Set;function g(e){t.status=e,v.forEach(s=>{s(e)}),e==="connected"&&function(){const s=[...t.buffer];t.buffer.splice(0,t.buffer.length),s.forEach(({type:d,data:h})=>{l(d,h)})}()}return window.addEventListener("message",o,!1),g("connecting"),{destroy:function(){["disconnected"].includes(t.status)||g("disconnected"),a.clear(),v.clear(),window.removeEventListener("message",o,!1)},inFrame:c,send:function(e,s){l(e,s)},subscribe:function(e){return a.add(e),()=>a.delete(e)},onStatusUpdate:function(e){return v.add(e),()=>v.delete(e)}}}function B(n){const{client:c,setFetcher:t,onConnect:l,onDisconnect:o}=n;if(!(c&&c instanceof N))throw new Error(`Expected \`client\` to be an instance of SanityClient or SanityStegaClient: ${JSON.stringify(c)}`);const{projectId:a,dataset:v}=c.config(),g=k("previewDrafts"),e=k(!1),s=new Map,d=F({id:"loaders",connectTo:"presentation"});let h;d.onStatusUpdate(f=>{f==="connected"?e.set(!0):f==="disconnected"&&e.set(!1)}),d.subscribe((f,i)=>{if(f==="loader/perspective"&&i.projectId===a&&i.dataset===v){if(i.perspective!=="published"&&i.perspective!=="previewDrafts")throw new Error(`Unsupported perspective: ${JSON.stringify(i.perspective)}`);g.set(i.perspective),b()}else if(f==="loader/query-change"&&i.projectId===a&&i.dataset===v){const{perspective:y,query:r,params:p}=i;i.result!==void 0&&i.resultSourceMap!==void 0&&c.config().stega.enabled?s.set(JSON.stringify({perspective:y,query:r,params:p}),{...i,result:O(i.result,i.resultSourceMap,c.config().stega)}):s.set(JSON.stringify({perspective:y,query:r,params:p}),i),b()}});const D=e.listen(f=>{f?(h=t({hydrate:(i,y,r)=>{const p=(r==null?void 0:r.perspective)||g.get(),w=JSON.stringify({perspective:p,query:i,params:y}),m=s.get(w);return(m==null?void 0:m.result)!==void 0&&(m==null?void 0:m.resultSourceMap)!==void 0?{loading:!1,error:void 0,data:m.result,sourceMap:m.resultSourceMap,perspective:p}:{loading:e.value===!0&&(r==null?void 0:r.data)===void 0||(r==null?void 0:r.sourceMap)===void 0,error:void 0,data:r==null?void 0:r.data,sourceMap:r==null?void 0:r.sourceMap,perspective:(r==null?void 0:r.perspective)||"published"}},fetch:(i,y,r,p)=>{try{const w=$(i,y,r);if(p.signal.addEventListener("abort",()=>{w(),b()},{once:!0}),b(),r.setKey("error",void 0),p.signal.aborted)return}catch(w){r.setKey("error",w),r.setKey("loading",!1)}}}),l==null||l()):(h==null||h(),o==null||o())}),S=new Set,$=(f,i,y)=>{const r={query:f,params:i,$fetch:y};S.add(r),U();const p=setInterval(()=>U(!0),1e3);return()=>{clearInterval(p),S.delete(r),U()}},U=f=>{if(!d)throw new Error("No channel");const i=g.get();for(const{query:y,params:r,$fetch:p}of S)d.send("loader/query-listen",{projectId:a,dataset:v,perspective:i,query:y,params:r,heartbeat:1e3}),!f&&e.value===!0&&p.setKey("loading",!0),p.setKey("perspective",i)};function b(){var f,i;const y=g.get(),r=[];for(const{query:p,params:w,$fetch:m}of S){const j=JSON.stringify({perspective:y,query:p,params:w}),M=s.get(j);M&&(m.set({data:M.result,error:void 0,loading:!1,perspective:y,sourceMap:M.resultSourceMap}),r.push(...(i=(f=M.resultSourceMap)==null?void 0:f.documents)!=null?i:[]))}d==null||d.send("loader/documents",{projectId:a,dataset:v,perspective:y,documents:r})}return()=>{h==null||h(),D(),d.destroy()}}export{B as enableLiveMode};
